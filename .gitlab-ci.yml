stages:
  - build
  - release

variables:
  CARGO_INCREMENTAL: "0"
  CARGO_HOME: "$CI_PROJECT_DIR/.cargo"
  RUSTUP_HOME: "$CI_PROJECT_DIR/.rustup"
  APP_NAME: "Stalker-GW"

cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .cargo/
    - .rustup/
    - node_modules/

build-linux:
  stage: build
  image: rust:latest
  rules:
    - if: $CI_COMMIT_TAG
  before_script:
    - apt-get update
    - apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf curl npm jq zip
    - rustup default stable
    - npm ci
  script:
    - npm run gen-icons
    - npm run tauri build
    - mkdir -p ./dist/linux
    - cp src-tauri/target/release/${APP_NAME} ./dist/linux/${APP_NAME}
    - npx tauri signer sign -k $TAURI_SIGNING_PRIVATE_KEY -p $TAURI_SIGNING_PRIVATE_KEY_PASSWORD ./dist/linux/${APP_NAME}
    - ls -la src-tauri/target/release
    - ls -la dist/linux
    - cd dist/linux && tar -czf ${APP_NAME}_linux.tar.gz ${APP_NAME} && cd ../..
  artifacts:
    paths:
      - dist/linux/

build-windows:
  stage: build
  image: ivangabriele/tauri:debian-bookworm-20
  rules:
    - if: $CI_COMMIT_TAG
  before_script:
    - export PATH="$CARGO_HOME/bin:$PATH"
    - rustup default stable
    - apt-get update
    - apt-get -y install nsis clang lld llvm jq zip
    - rustup target add x86_64-pc-windows-msvc
    - cargo install --locked --quiet cargo-xwin
    - npm ci
  script:
    - npm run gen-icons
    - npm run tauri-build-windows
    - mkdir -p ./dist/windows
    - cp src-tauri/target/x86_64-pc-windows-msvc/release/${APP_NAME}.exe ./dist/windows/${APP_NAME}.exe
    - npx tauri signer sign -k "${TAURI_SIGNING_PRIVATE_KEY}" -p "${TAURI_SIGNING_PRIVATE_KEY_PASSWORD}" ./dist/windows/${APP_NAME}.exe
    - ls -la src-tauri/target/x86_64-pc-windows-msvc/release
    - ls -la dist/windows
    - cd dist/windows && zip ${APP_NAME}_windows.zip ${APP_NAME}.exe && cd ../..
  artifacts:
    paths:
      - dist/windows/

publish-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_TAG
  needs:
    - build-linux
    - build-windows
  before_script:
    - apk add --no-cache git curl jq
  script: |
      # 1. Загрузка в Generic Packages
      curl --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file dist/linux/${APP_NAME}_linux.tar.gz "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/stalker-gw/${CI_COMMIT_TAG}/${APP_NAME}_linux.tar.gz"
      curl --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file dist/windows/${APP_NAME}_windows.zip "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/stalker-gw/${CI_COMMIT_TAG}/${APP_NAME}_windows.zip"

      LINUX_URL="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/stalker-gw/${CI_COMMIT_TAG}/${APP_NAME}_linux.tar.gz"
      WIN_URL="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/stalker-gw/${CI_COMMIT_TAG}/${APP_NAME}_windows.zip"

      # 2. Читаем сигнатуры из артефактов (пути теперь внутри dist/)
      SIG_LINUX=$(cat dist/linux/${APP_NAME}.sig || echo "")
      SIG_WIN=$(cat dist/windows/${APP_NAME}.exe.sig || echo "")

      # 3. Генерация JSON
      printf "{\n  \"version\": \"%s\",\n  \"notes\": \"Release %s\",\n  \"pub_date\": \"%s\",\n  \"platforms\": {\n    \"linux-x86_64\": { \"signature\": \"%s\", \"url\": \"%s\" },\n    \"windows-x86_64\": { \"signature\": \"%s\", \"url\": \"%s\" }\n  }\n}" "$CI_COMMIT_TAG" "$CI_COMMIT_TAG" "$(date -u +%Y-%m-%dT%H:%M:%SZ)" "$SIG_LINUX" "$LINUX_URL" "$SIG_WIN" "$WIN_URL" > updater.json

      # 4. Безопасный Push (используем токен в URL правильно)
      git config --global user.email "ci@gitlab.com"
      git config --global user.name "CI Bot"
      # Чистим URL от старых настроек и ставим актуальный с токеном
      git remote set-url origin "https://project_${CI_PROJECT_ID}_bot:${GITLAB_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git"

      # Работа с веткой
      git fetch origin master
      git checkout master || git checkout -b master origin/master

      git add updater.json
      git commit -m "chore: update updater.json to $CI_COMMIT_TAG [skip ci]" || echo "No changes to commit"
      git push origin master
  release:
    name: 'Release $CI_COMMIT_TAG'
    tag_name: '$CI_COMMIT_TAG'
    description: 'Portable binaries for Stalker-GW'
    assets:
      links:
        - name: 'Linux Binary (tar.gz)'
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/stalker-gw/${CI_COMMIT_TAG}/${APP_NAME}_linux.tar.gz"
        - name: 'Windows Binary (zip)'
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/stalker-gw/${CI_COMMIT_TAG}/${APP_NAME}_windows.zip"
