stages:
  - build
  - release

variables:
  CARGO_HOME: "$CI_PROJECT_DIR/.cargo"
  RUSTUP_HOME: "$CI_PROJECT_DIR/.rustup"
  APP_NAME: "Stalker-GW"

cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .cargo/
    - .rustup/
    - node_modules/

.tauri-build:
  image: node:20-bookworm
  rules:
    - if: $CI_COMMIT_TAG
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends curl build-essential libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libgtk-3-dev libayatana-appindicator3-dev libwebkit2gtk-4.0-dev libxtst-dev libx11-dev libxrandr-dev libxinerama-dev libxcomposite-dev libxdamage-dev libxss-dev libasound2-dev libssl-dev jq zip
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source "$CARGO_HOME/env"
    - npm ci

build-linux:
  extends: .tauri-build
  stage: build
  script:
    - npm run gen-icons
    - source "$CARGO_HOME/env"
    # Собираем только бинарник
    - npm run tauri build
    - mkdir -p ./dist/linux
    - cp src-tauri/target/release/${APP_NAME} ./dist/linux/${APP_NAME}
    # Tauri генерирует .sig для апдейтов при наличии ключей в ENV
    # Но для портативного бинарника нам нужно сжать его вручную, чтобы соответствовать схеме апдейтера
    - cd dist/linux && tar -czf ${APP_NAME}_linux.tar.gz ${APP_NAME} && cd ../..
  artifacts:
    paths:
      - dist/linux/

build-windows:
  stage: build
  image: ivangabriele/tauri:debian-bookworm-20
  rules:
    - if: $CI_COMMIT_TAG
  before_script:
    - apt-get update && apt-get -y install clang lld llvm jq zip
    - rustup target add x86_64-pc-windows-msvc
    - cargo install --locked cargo-xwin
    - source "$CARGO_HOME/env"
    - npm ci
  script:
    - npm run gen-icons
    - npm run tauri build
    - mkdir -p ./dist/windows
    - cp src-tauri/target/x86_64-pc-windows-msvc/release/${APP_NAME}.exe ./dist/windows/${APP_NAME}.exe
    # Архивируем для апдейтера
    - cd dist/windows && zip ${APP_NAME}_windows.zip ${APP_NAME}.exe && cd ../..
  artifacts:
    paths:
      - dist/windows/

publish-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_TAG
  needs:
    - build-linux
    - build-windows
  before_script:
    - apk add --no-cache git curl jq
  script: |
      curl --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file dist/linux/${APP_NAME}_linux.tar.gz "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/stalker-gw/${CI_COMMIT_TAG}/${APP_NAME}_linux.tar.gz"
      curl --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file dist/windows/${APP_NAME}_windows.zip "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/stalker-gw/${CI_COMMIT_TAG}/${APP_NAME}_windows.zip"

      LINUX_URL="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/stalker-gw/${CI_COMMIT_TAG}/${APP_NAME}_linux.tar.gz"
      WIN_URL="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/stalker-gw/${CI_COMMIT_TAG}/${APP_NAME}_windows.zip"

      SIG_LINUX=$(cat src-tauri/target/release/${APP_NAME}.sig || echo "")
      SIG_WIN=$(cat src-tauri/target/x86_64-pc-windows-msvc/release/${APP_NAME}.exe.sig || echo "")

      printf "{\n  \"version\": \"%s\",\n  \"notes\": \"Release %s\",\n  \"pub_date\": \"%s\",\n  \"platforms\": {\n    \"linux-x86_64\": { \"signature\": \"%s\", \"url\": \"%s\" },\n    \"windows-x86_64\": { \"signature\": \"%s\", \"url\": \"%s\" }\n  }\n}" "$CI_COMMIT_TAG" "$CI_COMMIT_TAG" "$(date -u +%Y-%m-%dT%H:%M:%SZ)" "$SIG_LINUX" "$LINUX_URL" "$SIG_WIN" "$WIN_URL" > updater.json

      git config --global user.email "ci@gitlab.com"
      git config --global user.name "CI Bot"
      git remote set-url origin https://oauth2:${GITLAB_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git
      git checkout main || git checkout -b main
      git add updater.json
      git commit -m "chore: update updater.json to $CI_COMMIT_TAG [skip ci]" || echo "No changes to commit"
      git push origin main
  release:
    name: 'Release $CI_COMMIT_TAG'
    tag_name: '$CI_COMMIT_TAG'
    description: 'Portable binaries for Stalker-GW'
    assets:
      links:
        - name: 'Linux Binary (tar.gz)'
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/stalker-gw/${CI_COMMIT_TAG}/${APP_NAME}_linux.tar.gz"
        - name: 'Windows Binary (zip)'
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/stalker-gw/${CI_COMMIT_TAG}/${APP_NAME}_windows.zip"
